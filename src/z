import os
import subprocess

def run(cmd):
    subprocess.run(cmd, check=True)

def run_ignore(cmd):
    try:
        subprocess.run(cmd, check=True)
    except subprocess.CalledProcessError:
        pass

# Find all .sln files
sln_files = [f for f in os.listdir() if f.endswith(".sln")]

if not sln_files:
    print("No .sln files found in this directory.")
    exit(1)

print("Select a solution file:")
for i, f in enumerate(sln_files):
    print(f"{i+1}. {f}")

choice = int(input("Enter number: ")) - 1
sln = sln_files[choice]

# Ensure identity (wonâ€™t overwrite if already set)
run_ignore(["git", "config", "--global", "user.name", "james9828"])
run_ignore(["git", "config", "--global", "user.email", "your_github_email"])

workflow = f"""name: Build

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3

    - name: Build Solution
      run: msbuild "{sln}" /p:Configuration=Release

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: |
          **/bin/Release/**
"""

os.makedirs(".github/workflows", exist_ok=True)

with open(".github/workflows/build.yml", "w") as f:
    f.write(workflow)

# Stage everything
run_ignore(["git", "add", "-A"])

try:
    run(["git", "commit", "-m", f"Update workflow for {sln}"])
except:
    print("Nothing new to commit.")

run_ignore(["git", "pull", "origin", "main", "--rebase"])
run(["git", "push", "origin", "main"])

print("Workflow synced and pushed successfully.")